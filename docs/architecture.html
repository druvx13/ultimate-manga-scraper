<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Complete documentation for the Ultimate Web Novel & Manga Scraper WordPress plugin">
    <title>Architecture - Ultimate Web Novel & Manga Scraper</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ðŸ“š Documentation</h2>
                <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search documentation..." class="search-input">
            </div>
            
            <ul class="nav-menu">
                <li class="nav-section">
                    <h3>Getting Started</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="user-guide.html">User Guide</a></li>
                        <li><a href="installation.html">Installation</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </li>
                
                <li class="nav-section">
                    <h3>Configuration</h3>
                    <ul>
                        <li><a href="configuration.html">Configuration Reference</a></li>
                        <li><a href="deployment.html">Deployment Guide</a></li>
                        <li><a href="performance.html">Performance Tuning</a></li>
                    </ul>
                </li>
                
                <li class="nav-section">
                    <h3>Developer Resources</h3>
                    <ul>
                        <li><a href="architecture.html" class="active">Architecture</a></li>
                        <li><a href="api-reference.html">API Reference</a></li>
                        <li><a href="data-flow.html">Data Flow</a></li>
                        <li><a href="directory-structure.html">Directory Structure</a></li>
                    </ul>
                </li>
                
                <li class="nav-section">
                    <h3>Support & Security</h3>
                    <ul>
                        <li><a href="troubleshooting.html">Troubleshooting</a></li>
                        <li><a href="security.html">Security</a></li>
                        <li><a href="changelog.html">Changelog</a></li>
                    </ul>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <a href="https://github.com/druvx13/ultimate-manga-scraper" target="_blank" class="github-link">
                    View on GitHub â†’
                </a>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <h1>Architecture</h1>
                <p class="subtitle">Ultimate Web Novel & Manga Scraper Documentation</p>
            </header>
            
            <div class="content">
                <h1>System Architecture</h1>
                <section></section><section><h2>Overview</h2>
                <p>The <strong>Ultimate Web Novel &amp; Manga Scraper</strong> is a monolithic WordPress plugin designed to automate the content ingestion pipeline for Manga and Web Novel sites. It is tightly coupled with the <strong>Madara</strong> WordPress theme and its associated core plugin (<code>WP_MANGA_STORAGE</code>).</p>
                <p>The system operates on a &quot;Rule&quot; based model, where administrators define scraping targets (URLs), schedules, and processing parameters. These rules are executed via WordPress Cron or manually triggered.</p>
                <section></section><section><h2>Core Components</h2>
                <h3>1. The God Object (<code>ultimate-manga-scraper.php</code>)</h3>
                <p>Almost all business logic resides in the main plugin file. This includes:</p>
                <ul>
                <li><strong>Initialization</strong>: Hook registration, text domain loading.</li>
                <li><strong>Cron Scheduler</strong>: <code>ums_cron</code> function orchestrates rule execution.</li>
                <li><strong>Scraping Engine</strong>: Logic for fetching HTML (<code>ums_get_web_page</code>), parsing DOM (<code>simple_html_dom</code>), and extracting content.</li>
                <li><strong>Headless Integration</strong>: Wrappers for <code>shell_exec</code> to call PhantomJS and Puppeteer.</li>
                <li><strong>Translation</strong>: Integration with Google, DeepL, and Microsoft Translator APIs.</li>
                <li><strong>Database Interaction</strong>: Direct calls to <code>wp_insert_post</code>, <code>update_post_meta</code>, and Madara specific storage functions.</li>
                </ul>
                <h3>2. Scraping Strategies</h3>
                <p>The plugin employs a tiered approach to fetching content:</p>
                <ol>
                <li><strong>Direct cURL/FileGetContents</strong>: Fast, low resource usage. Used for static sites.</li>
                <li><strong>PhantomJS</strong>: Legacy headless browser. Used when JavaScript rendering is required.<ul>
                <li><em>Mechanism</em>: <code>shell_exec(&#39;phantomjs res/phantomjs/phantom.js ...&#39;)</code></li>
                </ul>
                </li>
                <li><strong>Puppeteer (Node.js)</strong>: Modern headless browser. Used for complex JS sites or Cloudflare bypass.<ul>
                <li><em>Mechanism</em>: <code>shell_exec(&#39;node res/puppeteer/puppeteer.js ...&#39;)</code></li>
                </ul>
                </li>
                <li><strong>External APIs</strong>: Integration with &quot;HeadlessBrowserAPI&quot; (commercial service) as a fallback.</li>
                <li><strong>Tor</strong>: Support for routing traffic through Tor (via external API).</li>
                </ol>
                <h3>3. Madara Integration</h3>
                <p>The plugin is not a generic scraper; it is purpose-built for the <strong>Madara</strong> theme ecosystem.</p>
                <ul>
                <li><strong>Dependency</strong>: Checks for <code>WP_MANGA_STORAGE</code> class.</li>
                <li><strong>Data Model</strong>: Maps scraped data to <code>wp-manga</code> post type.</li>
                <li><strong>Taxonomies</strong>: Automatically creates and assigns:<ul>
                <li><code>wp-manga-genre</code></li>
                <li><code>wp-manga-author</code></li>
                <li><code>wp-manga-artist</code></li>
                <li><code>wp-manga-release</code> (Year)</li>
                </ul>
                </li>
                <li><strong>Chapter Storage</strong>: Handles the complex directory structure required by Madara for storing chapter images (e.g., <code>wp-content/uploads/manga/{uniqid}/{chapter_slug}/</code>).</li>
                </ul>
                <h3>4. Scheduler &amp; Execution</h3>
                <ol>
                <li><strong>Trigger</strong>: WP-Cron event <code>umsaction</code>.</li>
                <li><strong>Iterator</strong>: Loads all rules from <code>wp_options</code> (<code>ums_rules_list</code>, <code>ums_novel_list</code>, etc.).</li>
                <li><strong>Constraint Check</strong>: Checks <code>schedule</code> (time interval) vs <code>last_run</code>.</li>
                <li><strong>Locking</strong>: Uses file locking (<code>flock</code>) and database flags (<code>ums_running_list</code>) to prevent overlapping executions.</li>
                <li><strong>Execution</strong>: Calls <code>ums_run_rule($id, $type)</code>.</li>
                </ol>
                <h3>5. Content Processing Pipeline</h3>
                <pre><code>[Fetch HTML] -&gt; [Detect Cloudflare] -&gt; [Parse DOM] -&gt; [Extract Metadata]
                      |
                      v
                [Download Images/Text] -&gt; [Spin/Translate Content] -&gt; [Create WP Post]
                      |
                      v
                [Create Madara Volume] -&gt; [Create Madara Chapter] -&gt; [Move Images to Storage]
                </code></pre>
                <section></section><section><h2>Subsystems</h2>
                <h3>Madara Enhancements (<code>includes/</code>)</h3>
                <p>A separate module allowing users to search and add manga from &quot;Madara-based&quot; source sites (like <code>manhuaus.com</code>) using their internal AJAX APIs (<code>admin-ajax.php?action=madara_load_more</code>). This bypasses standard DOM scraping by consuming structured JSON/HTML responses.</p>
                <h3>Translation Engine</h3>
                <p>Supports both API-based (paid) and scraping-based (free/unstable) translation.</p>
                <ul>
                <li><strong>Google</strong>: Supports &quot;Free&quot; mode (scraping Google Translate web) and API mode.</li>
                <li><strong>DeepL</strong>: API integration.</li>
                <li><strong>Microsoft</strong>: API integration.</li>
                <li><strong>Text Spinner</strong>: Basic synonym replacement using <code>res/synonyms.dat</code>.</li>
                </ul>
                <h3>Image Handling</h3>
                <ul>
                <li><strong>Downloader</strong>: Fetches images via cURL.</li>
                <li><strong>Processor</strong>: Can resize images using <code>ImageResize</code> library.</li>
                <li><strong>Storage</strong>: Saves to WordPress Media Library (<code>wp_insert_attachment</code>) or directly to the file system for Madara&#39;s custom storage driver.</li>
                </ul>
                <section><h2>ASCII Diagram</h2>
                <pre><code>+---------------------------------------------------------+
                |                WordPress / Madara Theme                 |
                +---------------------------------------------------------+
                          ^                       ^
                          |                       |
                +---------+---------+   +---------+---------+
                |   Cron Scheduler  |   |    Admin UI       |
                | (ums_cron)        |   | (Settings/Rules)  |
                +---------+---------+   +---------+---------+
                          |                       |
                          v                       v
                +---------------------------------------------------------+
                |               Main Logic (God Object)                   |
                |             ultimate-manga-scraper.php                  |
                +---------------------------------------------------------+
                    |           |            |             |
                    v           v            v             v
                [Scrapers]  [Parser]    [Translator]   [Storage]
                    |           |            |             |
                    +-&gt; cURL    +-&gt; DOM      +-&gt; Google    +-&gt; WP DB
                    +-&gt; Phantom +-&gt; Regex    +-&gt; DeepL     +-&gt; Filesystem
                    +-&gt; Node    +-&gt; JSON     +-&gt; Bing      +-&gt; S3 (via Madara)
                </code></pre>
                </section>
            </div>
            
            <footer class="page-footer">
                <p>&copy; 2024 Ultimate Web Novel & Manga Scraper - Released into the Public Domain</p>
                <p>
                    <a href="https://github.com/druvx13/ultimate-manga-scraper">GitHub</a> â€¢
                    <a href="security.html#disclosure">Report Security Issue</a> â€¢
                    <a href="changelog.html">Changelog</a>
                </p>
            </footer>
        </main>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb" crossorigin="anonymous"></script>
    <script src="js/main.js"></script>
</body>
</html>
