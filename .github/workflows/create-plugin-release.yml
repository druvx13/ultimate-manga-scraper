name: Create WordPress Plugin Release

# Manual workflow that can be triggered from the GitHub Actions UI
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.0.4)'
        required: true
        type: string
      release_name:
        description: 'Release name (optional, defaults to version)'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Plugin Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to push commits and create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 2.0.4)"
            exit 1
          fi
          echo "Version format is valid: ${{ inputs.version }}"
      
      - name: Update plugin version
        run: |
          # Update version in main plugin file
          sed -i "s/\* Version: .*/\* Version: ${{ inputs.version }}/" ultimate-manga-scraper.php
          
          # Verify the change
          echo "Updated plugin version:"
          grep "Version:" ultimate-manga-scraper.php | head -1
      
      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ultimate-manga-scraper.php
          git commit -m "Bump version to ${{ inputs.version }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Create plugin package
        run: |
          # Create a directory for the plugin
          mkdir -p /tmp/ultimate-manga-scraper
          
          # Copy all necessary plugin files, excluding development files
          rsync -av --progress . /tmp/ultimate-manga-scraper/ \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='.DS_Store' \
            --exclude='Thumbs.db'
          
          # Create the ZIP file
          cd /tmp
          zip -r ultimate-manga-scraper-${{ inputs.version }}.zip ultimate-manga-scraper/
          
          # Move ZIP to workspace
          mv ultimate-manga-scraper-${{ inputs.version }}.zip $GITHUB_WORKSPACE/
          
          # Show ZIP file info
          ls -lh $GITHUB_WORKSPACE/ultimate-manga-scraper-${{ inputs.version }}.zip
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            cat CHANGELOG.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=No changelog available" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.0.4
        with:
          tag_name: v${{ inputs.version }}
          name: ${{ inputs.release_name || format('Version {0}', inputs.version) }}
          body: |
            # Ultimate Web Novel & Manga Scraper v${{ inputs.version }}
            
            ## Installation
            
            1. Download the `ultimate-manga-scraper-${{ inputs.version }}.zip` file below
            2. Go to your WordPress Admin Dashboard
            3. Navigate to Plugins â†’ Add New â†’ Upload Plugin
            4. Choose the downloaded ZIP file and click "Install Now"
            5. Activate the plugin
            
            ## Requirements
            
            - WordPress 5.0 or higher
            - PHP 7.4 or higher
            - Madara theme (required)
            - Madara Core plugin (required)
            
            ## Changelog
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            For detailed documentation, please visit the [GitHub repository](https://github.com/druvx13/ultimate-manga-scraper).
          files: |
            ultimate-manga-scraper-${{ inputs.version }}.zip
          draft: false
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release Summary
        run: |
          echo "### Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Name:** ${{ inputs.release_name || format('Version {0}', inputs.version) }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ultimate-manga-scraper-${{ inputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release is now available at: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
